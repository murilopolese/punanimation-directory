<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/demo/sample-content.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./punani-fab.html">
<link rel="import" href="./punani-filter.html">

<dom-module id="punani-app">
    <template>
        <style is="custom-style">
            :host {
                --color-white: #FFFFFF;
                --color-black: #000000;
                --color-grey: #EDEDED;
                --color-yellow: #FCC438;
                display: block;
                font-family: 'Open Sans';
                font-size: 12px;
            }
            a:link,
            a:visited,
            a:active,
            a:hover {
                color: var(--color-black);
                text-decoration: none;
            }
            #drawerMenu {
                z-index: 30;
                --app-drawer-content-container: {
                    box-shadow: 1px 0 2px 1px rgba(0,0,0,0.18);
                }
            }
            app-header {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background-color: var(--color-grey);
                color: var(--color-black);
                z-index: 10;
            }
            app-header paper-icon-button {
                --paper-icon-button-ink-color: var(--color-black);
            }
            .container {
                display: block;
                position: relative;
                max-width: 960px;
                margin: 0 auto;
                padding: 0 20px;
                z-index: 0;
            }

            #header-top {
                height: 160px;
                width: 100%;
            }

            #navigation,
            #social-media {
                position: absolute;
                top: 15px;
            }
            #social-media {
                right: 20px;
            }
            #navigation {
                left: 20px;
            }
            #navigation .item {
                font-weight: 600;
                font-size: 12px;
                letter-spacing: 0.15em;
                margin-right: 20px;
            }

            #title {
                @apply --layout-vertical;
                @apply --layout-center;
                @apply --layout-center-justified;
                height: 100%;
                text-align: center;
            }
            #title .logo {
                width: 130px;
                margin-bottom: 10px;
            }
            #title .description {
                letter-spacing: 0.07em;
            }

            #filters .col {
                margin: 10px 0 15px 0;
            }

            #feed {
                padding-top: 220px;
            }
            #feed .image {
                width: 540px;
                max-width: 100%;
                min-height: 200px;
                border: solid 1px var(--color-black);
                box-sizing: border-box;
                -moz-box-sizing: border-box;
                -webkit-box-sizing: border-box;
            }
            #feed .col {
                @apply --layout-vertical;
                @apply --layout-center;
                text-align: center;
                margin: 10px 0 10px 0;
                cursor: pointer;
            }
            #feed .name {
                display: inline-block;
                margin-top: 6px;
                font-weight: 900;
                font-size: 12px;
                letter-spacing: 0.1em;
                text-transform: uppercase;
            }
            #feed .location {
                display: inline-block;
                font-size: 10px;
                letter-spacing: 0.2em;
                margin-left: 4px;
            }

            .dialog {
                font-family: 'Open Sans';
                font-size: 12px;
                width: 500px;
                background: var(--color-yellow);
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
            }
            .dialog .name {
                font-size: 16px;
                font-weight: 800;
                letter-spacing: 0.03em;
                text-transform: uppercase;
            }
            .dialog .title {
                font-size: 14px;
                font-weight: 800;
                letter-spacing: 0.03em;
                text-transform: uppercase;
                margin-top: 0.8em;
                line-height: 0.8em;
            }
            .dialog .link {
                float: right;
                --punani-fab-size: 25px;
                --punani-fab-padding: 0px;
                --punani-fab-ripple-color: var(--color-white);
            }

            .row {
                @apply --layout-horizontal;
                @apply --layout-justified;
                @apply --layout-wrap;
            }
            .row .col {
                width: calc(33% - 20px);
                padding: 0 10px;
            }

            .hide-desktop {
                display: none;
            }
            @media (max-width: 768px) {
                .hide-mobile {
                    display: none;
                }
                .hide-desktop {
                    display: inherit;
                }
                #header-top {
                    height: 200px;
                }
                #feed {
                    padding-top: 360px;
                }
                #filters .col {
                    margin: 5px 0;
                }
                #filters .col:last-child {
                    margin-bottom: 15px;
                }
                .row {
                    @apply --layout-vertical;
                }
                .row .col {
                    padding: 0;
                    width: 100%;
                    max-width: none;
                }
                .dialog {
                    width: 100%;
                    margin: 24px 20px;
                }
            }
        </style>
        <app-header condenses reveals>
            <div id="header-top">
                <div class="container" style="height: 100%;">
                    <div id="navigation">
                        <div class="hide-mobile">
                            <a class="item" href="#">About</a>
                            <a class="item" href="#">Join</a>
                        </div>
                        <div class="hide-desktop">
                            <paper-icon-button
                                icon="menu"
                                on-tap="toggleMenu">
                            </paper-icon-button>
                        </div>
                    </div>
                    <div id="title">
                        <iron-image
                            class="logo"
                            src="/assets/logo.svg" alt="">
                        </iron-image>
                        <div class="description">
                            A directory of women, trans and non-binary people
                            working with animation and motion graphics.
                        </div>
                    </div>
                    <div id="social-media">
                        <div class="hide-mobile">
                            <a href="#">
                                <punani-fab>
                                    <iron-image
                                        src="/assets/facebook.svg"
                                        width="30"
                                        alt="">
                                    </iron-image>
                                </punani-fab>
                            </a>
                            <a href="#">
                                <punani-fab>
                                    <iron-image
                                        src="/assets/vimeo.svg"
                                        width="30"
                                        alt="">
                                    </iron-image>
                                </punani-fab>
                            </a>
                            <a href="#">
                                <punani-fab>
                                    <iron-image
                                        src="/assets/instagram.svg"
                                        width="30"
                                        alt="">
                                    </iron-image>
                                </punani-fab>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container" sticky>
                <div id="filters" class="row">
                    <div class="col">
                        <punani-filter
                            id="locationFilter"
                            items="[[locations]]"
                            is-hidden="{{locationHidden}}"
                            label="Location"
                            on-selection-changed="locationChanged">
                        </punani-filter>
                    </div>
                    <div class="col">
                        <punani-filter
                            id="skillsFilter"
                            items="[[skills]]"
                            extra-label="Extra Skills"
                            is-hidden="{{skillsHidden}}"
                            label="Skills"
                            on-selection-changed="skillsChanged">
                        </punani-filter>
                    </div>
                    <div class="col">
                        <punani-filter
                            id="softwaresFilter"
                            items="[[softwares]]"
                            is-hidden="{{softwaresHidden}}"
                            label="Softwares"
                            on-selection-changed="softwaresChanged">
                        </punani-filter>
                    </div>
                </div>
            </div>
        </app-header>

        <div id="feed" class="container">
            <iron-scroll-threshold id="ironScrollTheshold" on-lower-threshold="loadMoreData" scroll-target="document">
                <div class="row">
                    <template is="dom-repeat"
                        items="[[paginatedPunanis]]"
                        restamp
                        >
                        <div class="col" id="col-[[index]]" on-tap="openDialog">
                            <iron-image
                                class="image"
                                sizing="cover"
                                src="[[item.coverImage]]"
                                alt="[[item.name]]">
                            </iron-image>
                            <a>
                                <span class="name">
                                    [[item.name]]
                                </span>
                                <span class="location">
                                    ([[item.location.city]], [[item.location.country]])
                                </span>
                            </a>
                        </div>
                    </template>
                </div>
            </iron-scroll-threshold>
        </div>

        <template is="dom-repeat" items="[[punanis]]" restamp restampKey="_id">
            <paper-dialog id$="dialog-[[item._id]]" class="dialog" with-backdrop>
                <div>
                    <div class="name">
                        [[item.name]]
                        <template is="dom-if" if="[[item.website]]">
                            <a href$="[[!!item.website]]" target="_blank">
                                <punani-fab class="link">
                                    <iron-image
                                        src="/assets/link02.svg"
                                        width="60"
                                        alt="">
                                    </iron-image>
                                </punani-fab>
                            </a>
                        </template>
                    </div>
                    <div class="location">
                        <span>[[item.location.city]], [[item.location.country]]</span>
                    </div>
                    <div class="title">SKILLS</div>
                    <div>
                        <template is="dom-repeat" items="[[filterSkills(item.skills, 0)]]" as="skill">
                            <span>[[skill.name]]</span><span hidden$="[[lastSkill(index, item.skills, 0)]]">,</span><span hidden$="[[!lastSkill(index, item.skills, 0)]]">.</span>
                        </template>
                    </div>
                    <div class="title">EXTRA SKILLS</div>
                    <div>
                        <template is="dom-repeat" items="[[filterSkills(item.skills, 1)]]" as="skill">
                            <span>[[skill.name]]</span><span hidden$="[[lastSkill(index, item.skills, 1)]]">,</span><span hidden$="[[!lastSkill(index, item.skills, 1)]]">.</span>
                        </template>
                    </div>
                    <div class="title">SOFTWARES</div>
                    <div>
                        <template is="dom-repeat" items="[[item.softwares]]" as="softwares">
                            <span>[[softwares.name]]</span><span hidden$="[[lastItem(index, item.softwares)]]">,</span><span hidden$="[[!lastItem(index, item.softwares)]]">.</span>
                        </template>
                    </div>
                </div>
            </paper-dialog>
        </template>

        <app-drawer id="drawerMenu" align="start">
            <div>
                <a href="#">About</a>
            </div>
            <div>
                <a href="#">Join</a>
            </div>
            <div>
                <a href="#">
                    <punani-fab>
                        <iron-image
                            src="/assets/facebook.svg"
                            width="30"
                            alt="">
                        </iron-image>
                    </punani-fab>
                </a>
                <a href="#">
                    <punani-fab>
                        <iron-image
                            src="/assets/vimeo.svg"
                            width="30"
                            alt="">
                        </iron-image>
                    </punani-fab>
                </a>
                <a href="#">
                    <punani-fab>
                        <iron-image
                            src="/assets/instagram.svg"
                            width="30"
                            alt="">
                        </iron-image>
                    </punani-fab>
                </a>
            </div>
        </app-drawer>

    </template>

    <script>
    /**
    * @customElement
    * @polymer
    */
    class PunaniApp extends Polymer.GestureEventListeners(Polymer.Element) {
        static get is() { return 'punani-app'; }
        static get properties() {
            return {
                locationHidden: {
                    type: Boolean,
                    value: true,
                    notify: true
                },
                skillsHidden: {
                    type: Boolean,
                    value: true,
                    notify: true
                },
                softwaresHidden: {
                    type: Boolean,
                    value: true,
                    notify: true
                },
                locations: {
                    type: Array,
                    value: () => { return []; }
                },
                skills: {
                    type: Array,
                    value: () => { return []; }
                },
                softwares: {
                    type: Array,
                    value: () => { return []; }
                },
                punanis: {
                    type: Array,
                    value: () => { return []; }
                },
                filteredPunanis: {
                    type: Array,
                    computed: 'filterPunanis(punanis.*, locationFilter.*, skillsFilter.*, softwaresFilter.*)'
                },
                locationFilter: {
                    type: Array,
                    value: () => { return []; }
                },
                skillsFilter: {
                    type: Array,
                    value: () => { return []; }
                },
                softwaresFilter: {
                    type: Array,
                    value: () => { return []; }
                },
                currentPage: {
                    type: Number,
                    value: 0
                },
                pageSize: {
                    type: Number,
                    value: 12
                },
                paginatedPunanis: {
                    type: Array,
                    computed: 'computePaginatedPunanis(filteredPunanis.*, currentPage)'
                }
            };
        }
        static get observers() {
            return []
        }
        connectedCallback() {
            super.connectedCallback();
            window.addEventListener('click', this.hideOptions.bind(this), false);
            window.addEventListener('tap', this.hideOptions.bind(this), false);
            // window.addEventListener('scroll', this.hideOptions.bind(this), false);

            fetch('/api/locations')
                .then(r => r.json())
                .then((response) => {
                    if (response.locations) {
                        let locations = response.locations.map((location) => {
                            return {
                                id: location._id,
                                name: `${location.city}, ${location.country}`,
                                country: location.country,
                                city: location.city
                            };
                        });
                        locations = locations.sort((a, b) => {
                            if (a.city < b.city) return -1;
                            if (a.city > b.city) return 1;
                            return 0;
                        });
                        this.set('locations', locations);
                    }
                });
            fetch('/api/skills')
                .then(r => r.json())
                .then((response) => {
                    if (response.skills) {
                        const skills = response.skills.map((skill) => {
                            return {
                                id: skill._id,
                                name: `${skill.name}`,
                                extra: `${skill.extra}`
                            };
                        });
                        this.set('skills', skills);
                    }
                });
            fetch('/api/softwares')
                .then(r => r.json())
                .then((response) => {
                    if (response.softwares) {
                        const softwares = response.softwares.map((skill) => {
                            return {
                                id: skill._id,
                                name: `${skill.name}`
                            };
                        });
                        this.set('softwares', softwares);
                    }
                });
            fetch('/api/entries')
                .then(r => r.json())
                .then((response) => {
                    if (response.entries) {
                        this.set('punanis', response.entries);
                    }
                });
        }
        toggleMenu(e) {
            this.$.drawerMenu.toggle();
        }
        hideOptions(e) {
            if (!e.path) {
                // Screw you, Safari
                if (!this.$.locationFilter.isHidden) {
                    this.$.skillsFilter.set('isHidden', true);
                    this.$.softwaresFilter.set('isHidden', true);
                }
                if (!this.$.skillsFilter.isHidden) {
                    this.$.locationFilter.set('isHidden', true);
                    this.$.softwaresFilter.set('isHidden', true);
                }
                if (!this.$.softwaresFilter.isHidden) {
                    this.$.locationFilter.set('isHidden', true);
                    this.$.skillsFilter.set('isHidden', true);
                }
                return;
            }
            const filterElement = e.path.find((el) => {
                return el && el.tagName && el.tagName.toLowerCase() == 'punani-filter';
            });
            if (!filterElement) {
                this.$.locationFilter.set('isHidden', true);
                this.$.skillsFilter.set('isHidden', true);
                this.$.softwaresFilter.set('isHidden', true);
            } else {
                if (filterElement.id == 'locationFilter' && !filterElement.isHidden) {
                    this.$.skillsFilter.set('isHidden', true);
                    this.$.softwaresFilter.set('isHidden', true);
                }
                if (filterElement.id == 'skillsFilter' && !filterElement.isHidden) {
                    this.$.locationFilter.set('isHidden', true);
                    this.$.softwaresFilter.set('isHidden', true);
                }
                if (filterElement.id == 'softwaresFilter' && !filterElement.isHidden) {
                    this.$.locationFilter.set('isHidden', true);
                    this.$.skillsFilter.set('isHidden', true);
                }
            }
        }
        openDialog (e) {
            e.preventDefault();
            e.stopPropagation();
            const item = e.model.item;
            const dialog = Polymer.dom(this.root).querySelector(`#dialog-${item._id}`);
            if (dialog) {
                dialog.open();
            }
            return false;
        }
        lastItem (index, items) {
            return items.length-1 == index;
        }
        lastSkill(index, items, extra) {
            const skills = this.filterSkills(items, extra);
            return skills.length-1 == index;
        }
        /**
        * Filter skills array searching for elements that where the property
        * `extra` matches the argument `extra`.
        * @param {Array} skills Array of skills
        * @param {Boolean} extra Whether filter only extra skills only
        * @return {Array} Array of skills that matches its `extra` property with
        *     the argument `extra`.
        */
        filterSkills (skills, extra) {
            if (skills) {
                return skills.filter((skill) => {
                    return skill.extra == extra;
                });
            }
        }
        locationChanged (e) {
            console.log('locationChanged', e.detail);
            this.set('locationFilter', e.detail.selected.slice(0));
        }
        skillsChanged (e) {
            this.set('skillsFilter', e.detail.selected.slice(0));
        }
        softwaresChanged (e) {
            this.set('softwaresFilter', e.detail.selected.slice(0));
        }
        filterPunanis (punanis, locationFilter, skillsFilter, softwaresFilter) {
            if (
                !locationFilter || !locationFilter.base
                || !skillsFilter || !skillsFilter.base
                || !softwaresFilter || !softwaresFilter.base
                || !punanis || !punanis.base
            ) {
                return;
            }
            // Changing any filter, reset pagination and scroll to top
            this.set('currentPage', 0);
            return punanis.base.filter((punani) => {
                // The check for "in" something is either has no filter or has
                // a matching property with the selected filters
                const inLocation = locationFilter.base.length == 0 || locationFilter.base.find((filter) => {
                    return filter.id == punani.location._id;
                });
                const inSkills = skillsFilter.base.length == 0 || punani.skills.find((punaniSkill) => {
                    return skillsFilter.base.find((skill) => {
                        return punaniSkill._id == skill.id;
                    });
                });
                const inSoftwares = softwaresFilter.base.length == 0 || punani.softwares.find((punaniSoftwares) => {
                    return softwaresFilter.base.find((softwares) => {
                        return punaniSoftwares._id == softwares.id;
                    });
                });
                return inLocation && inSkills && inSoftwares;
            });
        }
        loadMoreData () {
            this.set('currentPage', this.currentPage+1);
            this.$.ironScrollTheshold.clearTriggers();
        }
        computePaginatedPunanis (filteredPunanis, currentPage) {
            const lastIndex = currentPage > 0 ? currentPage * this.pageSize: this.pageSize;
            if (lastIndex > filteredPunanis.base.lenth) {
                return filteredPunanis.base;
            }
            return filteredPunanis.base.slice(0, lastIndex);
        }
    }

    window.customElements.define(PunaniApp.is, PunaniApp);
    </script>
</dom-module>
