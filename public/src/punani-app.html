<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/demo/sample-content.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./punani-fab.html">
<link rel="import" href="./punani-filter.html">

<dom-module id="punani-app">
    <template>
        <style is="custom-style">
            :host {
                --color-white: #FFFFFF;
                --color-black: #000000;
                --color-grey: #EDEDED;
                --color-yellow: #FCC438;
                display: block;
                font-family: 'Open Sans';
                font-size: 12px;
            }
            a:link,
            a:visited,
            a:active,
            a:hover {
                color: var(--color-black);
                text-decoration: none;
            }
            app-header {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background-color: var(--color-grey);
                color: var(--color-black);
                z-index: 10;
            }
            app-header paper-icon-button {
                --paper-icon-button-ink-color: var(--color-black);
            }
            #drawerMenu {
                z-index: 30;
                --app-drawer-content-container: {
                    box-shadow: 1px 0 2px 1px rgba(0,0,0,0.18);
                }
            }
            #drawerMenu .navigation {
                margin-top: 15px;
            }
            #drawerMenu .navigation .item {
                font-weight: 600;
                font-size: 18px;
                letter-spacing: 0.15em;
                margin-right: 20px;
                padding: 7px 15px;
            }
            #drawerMenu .social-media {
                margin-top: 15px;
                text-align: center;
            }
            #drawerMenu .social-media .item {
                --punani-fab-size: 25px;
                --punani-fab-padding: 10px;
                width: 25px;
            }

            .container {
                display: block;
                position: relative;
                max-width: 960px;
                margin: 0 auto;
                padding: 0 20px;
                z-index: 0;
            }

            #header-top {
                height: 160px;
                width: 100%;
            }

            #navigation,
            #social-media {
                position: absolute;
                top: 20px;
            }
            #social-media {
                right: 20px;
            }
            #navigation {
                left: 20px;
            }
            #navigation .item {
                font-weight: 600;
                font-size: 12px;
                letter-spacing: 0.1em;
                margin-right: 20px;
                text-transform: uppercase;
            }

            #title {
                @apply --layout-vertical;
                @apply --layout-center;
                @apply --layout-center-justified;
                height: 100%;
                text-align: center;
            }
            #title .logo {
                width: 130px;
                margin-bottom: 10px;
                cursor: pointer;
            }
            #title .description {
                letter-spacing: 0.07em;
                cursor: pointer;
            }

            #filters .col {
                margin: 10px 0 15px 0;
            }

            #feed .image {
                width: 540px;
                max-width: 100%;
                min-height: 200px;
                border: solid 1px var(--color-black);
                box-sizing: border-box;
                -moz-box-sizing: border-box;
                -webkit-box-sizing: border-box;
            }
            #feed .col {
                @apply --layout-vertical;
                @apply --layout-center;
                text-align: center;
                margin: 10px 0 10px 0;
                cursor: pointer;
            }
            #feed .name {
                display: inline-block;
                margin-top: 6px;
                font-weight: 900;
                font-size: 12px;
                letter-spacing: 0.1em;
                text-transform: uppercase;
            }
            #feed .location {
                display: inline-block;
                font-size: 10px;
                letter-spacing: 0.13em;
                margin-left: 4px;
            }

            #about .col {
                font-size: 12px;
                letter-spacing: 0.07em;
            }
            #about .col a:link,
            #about .col a:visited,
            #about .col a:active,
            #about .col a:hover {
                font-weight: 700;
            }
            #about .title {
                font-size: 32px;
                letter-spacing: 0.02em;
                font-weight: 900;
                text-align: center;
                text-transform: uppercase;
            }
            #about .email {
                font-size: 18px;
                font-weight: 900;
                letter-spacing: 0.02em;
                line-height: 1em;
            }
            #about .col .title,
            #about .col .email,
            #about .col p {
                padding: 0 15px;
            }

            .padding-top {
                padding-top: 220px;
            }

            .dialog {
                font-family: 'Open Sans';
                font-size: 12px;
                width: 500px;
                background: var(--color-yellow);
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
            }
            .dialog .name {
                font-size: 16px;
                font-weight: 800;
                letter-spacing: 0.03em;
                text-transform: uppercase;
            }
            .dialog .title {
                font-size: 14px;
                font-weight: 800;
                letter-spacing: 0.03em;
                text-transform: uppercase;
                margin-top: 0.8em;
                line-height: 0.8em;
            }
            .dialog .location {
                line-height: 1em;
            }
            .dialog .link {
                float: right;
                --punani-fab-size: 25px;
                --punani-fab-padding: 0px;
                --punani-fab-ripple-color: var(--color-white);
            }

            .row {
                @apply --layout-horizontal;
                @apply --layout-justified;
                @apply --layout-wrap;
            }
            .row .col {
                width: calc(33% - 20px);
                padding: 0 10px;
            }

            .hide-desktop {
                display: none;
            }
            @media (max-width: 768px) {
                .hide-mobile {
                    display: none;
                }
                .hide-desktop {
                    display: inherit;
                }
                #header-top {
                    height: 200px;
                }
                #feed {
                    padding-top: 360px;
                }
                #filters .col {
                    margin: 5px 0;
                }
                #filters .col:last-child {
                    margin-bottom: 15px;
                }
                #about .email {
                    margin-bottom: 30px;
                }
                .row {
                    @apply --layout-vertical;
                }
                .row .col {
                    padding: 0;
                    width: 100%;
                    max-width: none;
                }
                .dialog {
                    width: 100%;
                    margin: 24px 20px;
                }
            }
        </style>
        <app-header condenses reveals>
            <div id="header-top">
                <div class="container" style="height: 100%;">
                    <div id="navigation">
                        <div class="hide-mobile">
                            <a class="item" href="#" on-tap="renderAbout">About</a>
                            <a class="item" target="_blank" href="https://punanimation.typeform.com/to/ZJL9Gx">Join</a>
                        </div>
                        <div class="hide-desktop">
                            <paper-icon-button
                                icon="menu"
                                on-tap="toggleMenu">
                            </paper-icon-button>
                        </div>
                    </div>
                    <div id="title">
                        <iron-image
                            on-tap="renderFeed"
                            class="logo"
                            src="/assets/logo.svg" alt="">
                        </iron-image>
                        <div class="description" on-tap="renderFeed">
                            A directory of women, trans and non-binary people
                            working with animation and motion graphics.
                        </div>
                    </div>
                    <div id="social-media">
                        <div class="hide-mobile">
                            <a target="_blank" href="https://www.facebook.com/groups/punanimation/">
                                <punani-fab style="width: 20px;">
                                    <iron-image
                                        src="/assets/facebook.svg"
                                        width="30"
                                        alt="">
                                    </iron-image>
                                </punani-fab>
                            </a>
                            <a target="_blank" href="https://vimeo.com/channels/punanimation">
                                <punani-fab>
                                    <iron-image
                                        src="/assets/vimeo.svg"
                                        width="30"
                                        alt="">
                                    </iron-image>
                                </punani-fab>
                            </a>
                            <a target="_blank" href="https://instagram.com/punanimation/">
                                <punani-fab>
                                    <iron-image
                                        src="/assets/instagram.svg"
                                        width="30"
                                        alt="">
                                    </iron-image>
                                </punani-fab>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <iron-pages
                selected="[[currentPageName]]"
                attr-for-selected="page-name"
                fallback-selection="fallback"
                sticky>
                <div page-name="feed">
                    <div class="container">
                        <div id="filters" class="row">
                            <div class="col">
                                <punani-filter
                                    id="locationFilter"
                                    items="[[locations]]"
                                    is-hidden="{{locationHidden}}"
                                    label="Location"
                                    on-selection-changed="locationChanged">
                                </punani-filter>
                            </div>
                            <div class="col">
                                <punani-filter
                                    id="skillsFilter"
                                    items="[[skills]]"
                                    extra-label="Extra Skills"
                                    is-hidden="{{skillsHidden}}"
                                    label="Skills"
                                    on-selection-changed="skillsChanged">
                                </punani-filter>
                            </div>
                            <div class="col">
                                <punani-filter
                                    id="softwaresFilter"
                                    items="[[softwares]]"
                                    is-hidden="{{softwaresHidden}}"
                                    label="Softwares"
                                    on-selection-changed="softwaresChanged">
                                </punani-filter>
                            </div>
                        </div>
                    </div>
                </div>
                <div page-name="fallback">
                    <div class="container"></div>
                </div>
            </iron-pages>
        </app-header>

        <iron-pages
            selected="[[currentPageName]]"
            attr-for-selected="page-name"
            fallback-selection="fallback">
            <div page-name="feed">
                <div id="feed" class="container padding-top">
                    <iron-scroll-threshold id="ironScrollTheshold" on-lower-threshold="loadMoreData" scroll-target="document">
                            <div class="row">
                                <template is="dom-repeat"
                                items="[[paginatedPunanis]]"
                                restamp>
                                <div class="col" id="col-[[index]]" on-tap="openDialog">
                                    <iron-image
                                    class="image"
                                    sizing="cover"
                                    src="[[item.coverImage]]"
                                    alt="[[item.name]]">
                                </iron-image>
                                <a>
                                    <span class="name">
                                        [[item.name]]
                                    </span>
                                    <span class="location">
                                        ([[item.location.city]], [[item.location.country]])
                                    </span>
                                </a>
                            </div>
                        </template>
                    </div>
                    </iron-scroll-threshold>
                </div>
            </div>

            <div page-name="about">
                <div id="about" class="container padding-top">
                    <div class="row">
                        <div class="col">
                            <div class="title">Who</div>
                            <p>
                                Punanimation was founded in April 2015, by 3
                                friends: <a target="_blank" href="https://beegrandinetti.com">Bee Grandinetti</a>,
                                <a target="_blank" href="https://vimeo.com/hedvigahlberg">Hedvig Ahlberg</a> and
                                <a target="_blank" href="http://www.linnfritz.com/">Linn Fritz</a>.
                            </p>
                            <p>
                                Although we were originally just 3, today our
                                whole community is built by over 1700 women,
                                trans and non-binary friends from all over the
                                world, working within the many different fields
                                and specializations of animation and motion
                                graphics.
                            </p>
                        </div>
                        <div class="col">
                            <div class="title">Why</div>
                                <p>
                                    We were a bit tired of this industry being
                                    too much of a boy’s club, so we decided to
                                    do something about it.
                                </p>
                                <p>
                                    Punanimation started as facebook group,
                                    aiming to bring the ladies, trans and
                                    non-binary people together. The community
                                    started to expand and our dear members
                                    helped shaping it into a lively, inspiring
                                    and awesome platform to exchange knowledge
                                    and support.
                                </p>
                                <p>
                                    Since then, we've been receiving so many
                                    words of encouragement from our members that
                                    it just confirms this was not only the right
                                    thing to do, but very much needed.
                                </p>
                                <p>
                                    This pushed us to work on the next, bigger
                                    step: putting together a directory that
                                    makes it easy for anyone to get a hold of
                                    that talent.
                                </p>
                                <p>
                                    No more excuses for male-only studios,
                                    speaker line-ups and director rosters.
                                    Diversity exists, it's got skills and it's
                                    here.
                                </p>
                        </div>
                        <div class="col">
                            <div class="title">
                                <iron-image src="assets/email.svg" width="38"></iron-image>
                            </div>
                            <p>
                                If you have any questions or just wanna reach
                                out, send a line to:
                            </p>
                            <div class="email"><a target="_blank" href="mailto:hey@punanimation.com">hey@punanimation.com</a></div>
                        </div>
                    </div>
                </div>
            </div>
            <div page-name="fallback">
                <div class="container padding-top" page-name="fallback">
                </div>
            </div>
        </iron-pages>

        <template is="dom-repeat" items="[[punanis]]" restamp restampKey="_id">
            <paper-dialog id$="dialog-[[item._id]]" class="dialog" with-backdrop>
                <div>
                    <div class="name">
                        [[item.name]]
                        <template is="dom-if" if="[[item.website]]">
                            <a href$="[[item.website]]" target="_blank">
                                <punani-fab class="link">
                                    <iron-image
                                        src="/assets/link02.svg"
                                        width="60"
                                        alt="">
                                    </iron-image>
                                </punani-fab>
                            </a>
                        </template>
                    </div>
                    <div class="location">
                        <span>[[item.location.city]], [[item.location.country]]</span>
                    </div>
                    <div class="title">SKILLS</div>
                    <div>
                        <template is="dom-repeat" items="[[filterSkills(item.skills, 0)]]" as="skill">
                            <span>[[skill.name]]</span><span hidden$="[[lastSkill(index, item.skills, 0)]]">,</span><span hidden$="[[!lastSkill(index, item.skills, 0)]]">.</span>
                        </template>
                    </div>
                    <div class="title">EXTRA SKILLS</div>
                    <div>
                        <template is="dom-repeat" items="[[filterSkills(item.skills, 1)]]" as="skill">
                            <span>[[skill.name]]</span><span hidden$="[[lastSkill(index, item.skills, 1)]]">,</span><span hidden$="[[!lastSkill(index, item.skills, 1)]]">.</span>
                        </template>
                    </div>
                    <div class="title">SOFTWARES</div>
                    <div>
                        <template is="dom-repeat" items="[[item.softwares]]" as="softwares">
                            <span>[[softwares.name]]</span><span hidden$="[[lastItem(index, item.softwares)]]">,</span><span hidden$="[[!lastItem(index, item.softwares)]]">.</span>
                        </template>
                    </div>
                </div>
            </paper-dialog>
        </template>

        <app-drawer id="drawerMenu" align="start">
            <div class="navigation">
                <div class="item">
                    <a href="#" on-tap="renderFeed">Home</a>
                </div>
                <div class="item">
                    <a href="#" on-tap="renderAbout">About</a>
                </div>
                <div class="item">
                    <a target="_blank" href="https://punanimation.typeform.com/to/ZJL9Gx">Join</a>
                </div>
            </div>
            <div class="social-media">
                <a class="item" target="_blank" href="https://www.facebook.com/groups/punanimation/">
                    <punani-fab>
                        <iron-image
                            src="/assets/facebook.svg"
                            width="30"
                            alt="">
                        </iron-image>
                    </punani-fab>
                </a>
                <a class="item" target="_blank" href="https://vimeo.com/channels/punanimation">
                    <punani-fab>
                        <iron-image
                            src="/assets/vimeo.svg"
                            width="30"
                            alt="">
                        </iron-image>
                    </punani-fab>
                </a>
                <a class="item" target="_blank" href="https://instagram.com/punanimation/">
                    <punani-fab>
                        <iron-image
                            src="/assets/instagram.svg"
                            width="30"
                            alt="">
                        </iron-image>
                    </punani-fab>
                </a>
            </div>
        </app-drawer>

    </template>

    <script>
    /**
    * @customElement
    * @polymer
    */
    class PunaniApp extends Polymer.GestureEventListeners(Polymer.Element) {
        static get is() { return 'punani-app'; }
        static get properties() {
            return {
                locationHidden: {
                    type: Boolean,
                    value: true,
                    notify: true
                },
                skillsHidden: {
                    type: Boolean,
                    value: true,
                    notify: true
                },
                softwaresHidden: {
                    type: Boolean,
                    value: true,
                    notify: true
                },
                locations: {
                    type: Array,
                    value: () => { return []; }
                },
                skills: {
                    type: Array,
                    value: () => { return []; }
                },
                softwares: {
                    type: Array,
                    value: () => { return []; }
                },
                punanis: {
                    type: Array,
                    value: () => { return []; }
                },
                filteredPunanis: {
                    type: Array,
                    computed: 'filterPunanis(punanis.*, locationFilter.*, skillsFilter.*, softwaresFilter.*)'
                },
                locationFilter: {
                    type: Array,
                    value: () => { return []; }
                },
                skillsFilter: {
                    type: Array,
                    value: () => { return []; }
                },
                softwaresFilter: {
                    type: Array,
                    value: () => { return []; }
                },
                currentFeedPage: {
                    type: Number,
                    value: 0
                },
                pageSize: {
                    type: Number,
                    value: 12
                },
                paginatedPunanis: {
                    type: Array,
                    computed: 'computePaginatedPunanis(filteredPunanis.*, currentFeedPage)'
                },
                currentPageName: {
                    type: String,
                    value: 'feed'
                }
            };
        }
        static get observers() {
            return []
        }
        connectedCallback() {
            super.connectedCallback();
            window.addEventListener('click', this.hideOptions.bind(this), false);
            window.addEventListener('tap', this.hideOptions.bind(this), false);
            // window.addEventListener('scroll', this.hideOptions.bind(this), false);

            fetch('/api/locations')
                .then(r => r.json())
                .then((response) => {
                    if (response.locations) {
                        let locations = response.locations.map((location) => {
                            return {
                                id: location._id,
                                name: `${location.city}, ${location.country}`,
                                country: location.country,
                                city: location.city
                            };
                        });
                        locations = locations.sort((a, b) => {
                            if (a.city < b.city) return -1;
                            if (a.city > b.city) return 1;
                            return 0;
                        });
                        this.set('locations', locations);
                    }
                });
            fetch('/api/skills')
                .then(r => r.json())
                .then((response) => {
                    if (response.skills) {
                        const skills = response.skills.map((skill) => {
                            return {
                                id: skill._id,
                                name: `${skill.name}`,
                                extra: `${skill.extra}`
                            };
                        });
                        this.set('skills', skills);
                    }
                });
            fetch('/api/softwares')
                .then(r => r.json())
                .then((response) => {
                    if (response.softwares) {
                        const softwares = response.softwares.map((skill) => {
                            return {
                                id: skill._id,
                                name: `${skill.name}`
                            };
                        });
                        this.set('softwares', softwares);
                    }
                });
            fetch('/api/entries')
                .then(r => r.json())
                .then((response) => {
                    if (response.entries) {
                        this.set('punanis', response.entries);
                    }
                });
        }
        toggleMenu(e) {
            this.$.drawerMenu.toggle();
        }
        hideOptions(e) {
            if (!e.path) {
                // Screw you, Safari
                if (!this.$.locationFilter.isHidden) {
                    this.$.skillsFilter.set('isHidden', true);
                    this.$.softwaresFilter.set('isHidden', true);
                }
                if (!this.$.skillsFilter.isHidden) {
                    this.$.locationFilter.set('isHidden', true);
                    this.$.softwaresFilter.set('isHidden', true);
                }
                if (!this.$.softwaresFilter.isHidden) {
                    this.$.locationFilter.set('isHidden', true);
                    this.$.skillsFilter.set('isHidden', true);
                }
                return;
            }
            const filterElement = e.path.find((el) => {
                return el && el.tagName && el.tagName.toLowerCase() == 'punani-filter';
            });
            if (!filterElement) {
                this.$.locationFilter.set('isHidden', true);
                this.$.skillsFilter.set('isHidden', true);
                this.$.softwaresFilter.set('isHidden', true);
            } else {
                if (filterElement.id == 'locationFilter' && !filterElement.isHidden) {
                    this.$.skillsFilter.set('isHidden', true);
                    this.$.softwaresFilter.set('isHidden', true);
                }
                if (filterElement.id == 'skillsFilter' && !filterElement.isHidden) {
                    this.$.locationFilter.set('isHidden', true);
                    this.$.softwaresFilter.set('isHidden', true);
                }
                if (filterElement.id == 'softwaresFilter' && !filterElement.isHidden) {
                    this.$.locationFilter.set('isHidden', true);
                    this.$.skillsFilter.set('isHidden', true);
                }
            }
        }
        openDialog (e) {
            e.preventDefault();
            e.stopPropagation();
            const item = e.model.item;
            const dialog = Polymer.dom(this.root).querySelector(`#dialog-${item._id}`);
            if (dialog) {
                dialog.open();
            }
            return false;
        }
        lastItem (index, items) {
            return items.length-1 == index;
        }
        lastSkill(index, items, extra) {
            const skills = this.filterSkills(items, extra);
            return skills.length-1 == index;
        }
        /**
        * Filter skills array searching for elements that where the property
        * `extra` matches the argument `extra`.
        * @param {Array} skills Array of skills
        * @param {Boolean} extra Whether filter only extra skills only
        * @return {Array} Array of skills that matches its `extra` property with
        *     the argument `extra`.
        */
        filterSkills (skills, extra) {
            if (skills) {
                return skills.filter((skill) => {
                    return skill.extra == extra;
                });
            }
        }
        locationChanged (e) {
            console.log('locationChanged', e.detail);
            this.set('locationFilter', e.detail.selected.slice(0));
        }
        skillsChanged (e) {
            this.set('skillsFilter', e.detail.selected.slice(0));
        }
        softwaresChanged (e) {
            this.set('softwaresFilter', e.detail.selected.slice(0));
        }
        filterPunanis (punanis, locationFilter, skillsFilter, softwaresFilter) {
            if (
                !locationFilter || !locationFilter.base
                || !skillsFilter || !skillsFilter.base
                || !softwaresFilter || !softwaresFilter.base
                || !punanis || !punanis.base
            ) {
                return;
            }
            // Changing any filter, reset pagination and scroll to top
            this.set('currentFeedPage', 0);
            return punanis.base.filter((punani) => {
                // The check for "in" something is either has no filter or has
                // a matching property with the selected filters
                const inLocation = locationFilter.base.length == 0 || locationFilter.base.find((filter) => {
                    return filter.id == punani.location._id;
                });
                const inSkills = skillsFilter.base.length == 0 || punani.skills.find((punaniSkill) => {
                    return skillsFilter.base.find((skill) => {
                        return punaniSkill._id == skill.id;
                    });
                });
                const inSoftwares = softwaresFilter.base.length == 0 || punani.softwares.find((punaniSoftwares) => {
                    return softwaresFilter.base.find((softwares) => {
                        return punaniSoftwares._id == softwares.id;
                    });
                });
                return inLocation && inSkills && inSoftwares;
            });
        }
        loadMoreData () {
            this.set('currentFeedPage', this.currentFeedPage+1);
            this.$.ironScrollTheshold.clearTriggers();
        }
        computePaginatedPunanis (filteredPunanis, currentFeedPage) {
            const lastIndex = currentFeedPage > 0 ? currentFeedPage * this.pageSize: this.pageSize;
            if (lastIndex > filteredPunanis.base.lenth) {
                return filteredPunanis.base;
            }
            return filteredPunanis.base.slice(0, lastIndex);
        }
        renderFeed() {
            if (typeof ga != 'undefined') {
                ga('send', {
                    hitType: 'event',
                    eventCategory: 'pageView',
                    eventAction: 'feed',
                    eventLabel: 'Navigation'
                });
            }
            this.set('currentPageName', 'feed');
            this.$.drawerMenu.close();
            return false;
        }
        renderAbout() {
            if (typeof ga != 'undefined') {
                ga('send', {
                    hitType: 'event',
                    eventCategory: 'pageView',
                    eventAction: 'about',
                    eventLabel: 'Navigation'
                });
            }
            this.set('currentPageName', 'about');
            this.$.drawerMenu.close();
            return false;
        }
    }

    window.customElements.define(PunaniApp.is, PunaniApp);
    </script>
</dom-module>
